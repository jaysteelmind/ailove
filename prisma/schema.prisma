generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  dateOfBirth   DateTime @map("date_of_birth")
  gender        String
  location      Json     // { latitude, longitude, city, country }
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  profile       UserProfile?
  traits        UserTrait[]
  conversationMessages ConversationMessage[]
  matchesFrom   Match[]      @relation("UserMatches")
  matchesTo     Match[]      @relation("MatchedUsers")
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  dates         Date[]

  @@map("users")
}

model UserProfile {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  bio               String?
  photos            String[]
  preferences       Json     // Dating preferences
  knowYouMeterScore Float    @default(0) @map("know_you_meter_score")
  conversationCount Int      @default(0) @map("conversation_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserTrait {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  dimension  String   // values, interests, communication, lifestyle, goals
  trait      String
  value      Float
  confidence Float
  source     String   // conversation, explicit, inferred
  extractedAt DateTime @default(now()) @map("extracted_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dimension, trait])
  @@map("user_traits")
}

model Match {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  matchedUserId   String    @map("matched_user_id")
  rbsScore        Float     @map("rbs_score")
  srScore         Float     @map("sr_score")
  cuScore         Float     @map("cu_score")
  igScore         Float     @map("ig_score")
  scScore         Float     @map("sc_score")
  status          String    @default("pending") // pending, accepted, rejected, expired
  viewedAt        DateTime? @map("viewed_at")
  respondedAt     DateTime? @map("responded_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  expiresAt       DateTime  @map("expires_at")
  
  user        User @relation("UserMatches", fields: [userId], references: [id], onDelete: Cascade)
  matchedUser User @relation("MatchedUsers", fields: [matchedUserId], references: [id], onDelete: Cascade)
  messages    Message[]
  dates       Date[]

  @@unique([userId, matchedUserId])
  @@index([userId, status])
  @@index([matchedUserId, status])
  @@map("matches")
}

model ConversationMessage {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  content    String
  role       String   // user, assistant
  extractedTraits Json? @map("extracted_traits")
  createdAt  DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("conversation_messages")
}

model Date {
  id              String    @id @default(uuid())
  matchId         String    @map("match_id")
  userId          String    @map("user_id")
  partnerId       String    @map("partner_id")
  proposedBy      String    @map("proposed_by")
  scheduledAt     DateTime  @map("scheduled_at")
  location        Json
  proposedLocations Json?   @map("proposed_locations")
  activityType    String?   @map("activity_type")
  status          String    @default("proposed")
  confirmedAt     DateTime? @map("confirmed_at")
  feedbackRating  Int?      @map("feedback_rating")
  feedbackText    String?   @map("feedback_text")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  match   Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  @@index([matchId, status])
  @@index([userId, status])
  @@index([partnerId, status])
  @@map("dates")
}
model CausalUpliftModel {
  id          String   @id @default(uuid())
  version     String   @unique
  modelData   Bytes    @map("model_data")
  accuracy    Float
  trainedOn   Int      @map("trained_on") // Number of samples
  deployedAt  DateTime @default(now()) @map("deployed_at")
  
  @@map("causal_uplift_models")
}

model Message {
  id          String    @id @default(uuid())
  matchId     String    @map("match_id")
  senderId    String    @map("sender_id")
  receiverId  String    @map("receiver_id")
  content     String    @db.Text
  contentType String    @default("text") @map("content_type") // text, image, etc
  status      String    @default("sent") // sent, delivered, read
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@index([matchId, createdAt])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("messages")
}
